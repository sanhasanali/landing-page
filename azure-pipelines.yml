trigger:
  branches:
    include:
      - master

variables:
  imageName: 'landing-page'
  acrLoginServer: 'myacrlanding.azurecr.io'
  kubernetesNamespace: 'default'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build and Push Image to ACR'
    pool:
      name: default
    steps:
    - checkout: self

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'conn-landing'  # Ganti dengan nama service connection kamu
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ” Login ke ACR"
          az acr login --name myacrlogin

          echo "ğŸ³ Build Docker Image"
          docker build -t $(acrLoginServer)/$(imageName):$(Build.BuildId) .

          echo "ğŸš€ Push ke ACR"
          docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: 'Deploy to AKS via kubectl'
    pool:
      name: default
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'conn-landing'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ“¦ Get kubeconfig dari AKS"
          az aks get-credentials --resource-group rs-group-landing --name myaks-landing --overwrite-existing

          echo "ğŸ“¦ Update image pada deployment"
          kubectl set image deployment/landing-page landing-page=$(acrLoginServer)/$(imageName):$(Build.BuildId) -n $(kubernetesNamespace)

          echo "âœ… Deployment selesai"

